# Geminiのためのプロジェクトドキュメント

## プロジェクト名

Google Drive 翻訳ツール

## プロジェクト概要

このプロジェクトは、Google Apps Script（GAS）で構築された、Google Drive上のファイルをAIで翻訳するツールです。Google スプレッドシート、ドキュメント、プレゼンテーションに対応しています。最大の特徴は、**AI駆動の辞書学習システム**であり、翻訳を実行するたびに自動で辞書を拡充し、継続的に翻訳品質を向上させます。OpenAIの`gpt-4.1-mini`モデルを活用しています。

## 設計思想

- **AI駆動の継続的学習**: 翻訳プロセスに「用語抽出 → 辞書照合 → 翻訳 → 辞書登録」のサイクルを組み込み、使うほどに賢くなるシステムを実現します。ユーザーの手間を最小限に抑えつつ、専門用語の翻訳精度と一貫性を自動で高めます。
- **モジュール性**: `FileHandler`, `Translator`, `Dictionary`, `History`, そして新しく追加された`TermExtractor`, `TermMatcher`, `DictionaryQualityManager`といったクラスベースの設計を採用し、各機能の関心を分離しています。これにより、保守性と拡張性を高めています。
- **設定の集中管理**: `Config.gs`にAPIキー、モデル名、各種IDなどの設定を集約し、環境ごとの設定変更を容易にしています。
- **堅牢性と信頼性**: Queue方式の非同期処理により、GASの実行時間制限（6分）を回避し、大容量ファイルでも安定して処理できるように設計されています。エラーハンドリングも各所に実装しています。
- **ユーザー中心**: 専門知識がなくても使えるWeb UIを提供し、翻訳プロセスの進捗をリアルタイムで確認できます。カスタム辞書機能も引き続き利用可能です。

## プロジェクト構成

- **`Code.gs`**: メインファイル。UIを提供し、フロントエンドからの非同期リクエストを管理するQueue処理のオーケストレーターです。
- **`Config.gs`**: 設定ファイル。APIキーやスプレッドシートIDなどを管理します。
- **`FileHandler.gs`**: ファイル操作クラス。ファイルの読み込み、ジョブ（セル単位など）への分割、翻訳済みファイルの作成を担当します。
- **`TermExtractor.gs`**: AI用語抽出クラス。OpenAI API(`gpt-4.1-mini`)を使い、翻訳対象のテキストから重要な用語を抽出します。
- **`TermMatcher.gs`**: 辞書照合クラス。`TermExtractor`が抽出した用語と、`Dictionary`に登録されている既存の用語を高速で照合します。
- **`Translator.gs`**: 翻訳処理クラス。`TermMatcher`の照合結果（確定ペア）を強制適用するプロンプトを生成し、OpenAI API(`gpt-4.1-mini`)で翻訳を実行します。
- **`Dictionary.gs`**: 辞書管理クラス。スプレッドシートをDBとして利用し、辞書のCRUD、キャッシュ管理、そして翻訳後に新しい用語を自動登録する機能を持ちます。
- **`DictionaryQualityManager.gs`**: 辞書品質管理クラス。翻訳によって得られた新しい用語ペアが辞書に登録する価値があるか（例：未翻訳でないか、無意味な記号でないか）を評価します。
- **`History.gs`**: 履歴管理クラス。翻訳結果をスプレッドシートに記録し、統計情報を生成します。
- **`Utils.gs`**: ユーティリティ関数群。プロジェクト全体で使われる共通のヘルパー関数を格納します。
- **`UI.html`**: フロントエンド。HTML, CSS, JavaScriptで構成されたSPA。`google.script.run`でバックエンド関数を呼び出します。

## 主なワークフロー：1件ずつ学習・翻訳するQueue方式ワークフロー

### フェーズ1: 翻訳ジョブのセットアップ

1.  **UI**: ユーザーがファイルURLを入力し、「翻訳を開始」ボタンをクリックします。
2.  **`UI.html`**: `google.script.run`を使い、`setupTranslationQueue`関数（`Code.gs`内）を呼び出します。
3.  **`Code.gs`**: `setupTranslationQueue`関数がリクエストを受け取ります。
4.  **`FileHandler`**:
    - `getFileInfo`でファイルの基本情報を取得します。
    - `createEmptyTranslatedFile`で翻訳先の空ファイルを事前作成します。
    - `createTranslationJobs`でファイルを個別のジョブ（例：セル単位）に分割します。
5.  **`Code.gs`**:
    - タスクIDを生成し、ジョブ情報をキャッシュに保存します。
    - セットアップ結果（タスクID、総ジョブ数、翻訳先ファイルURL）を`UI.html`に返します。

### フェーズ2: 非同期学習・翻訳ループ

6.  **`UI.html`**: セットアップ完了後、`processNextInQueue`関数を繰り返し呼び出します。
7.  **`Code.gs`**: `processNextInQueue`が1つのジョブを処理します。
    - キャッシュから次のジョブを取り出します。
8.  **`TermExtractor`**: `extractTerms`を呼び出し、現在のジョブのテキストから用語を抽出します。
9.  **`TermMatcher`**: `matchTerms`を呼び出し、抽出された用語が既存の辞書にあるか照合します。
10. **`Translator`**: `translateText`を呼び出します。この際、辞書と一致した用語（確定ペア）は翻訳時に強制的に適用されるようプロンプトが工夫されます。
11. **`DictionaryQualityManager`**: `filterTerms`を使い、翻訳結果から得られた新しい「原文と訳文のペア」が辞書登録に適しているか品質をチェックします。
12. **`Dictionary`**: `addTerms`を呼び出し、品質チェックを通過した新しい用語ペアを辞書（スプレッドシート）に登録・キャッシュを更新します。これにより、同じファイル内の後続のジョブで、登録されたばかりの用語が即座に使われるようになります。
13. **`FileHandler`**: `writeTranslatedJob`で翻訳結果をリアルタイムでファイルに書き込みます。
14. **`Code.gs`**: 処理状況（processing/complete/error）と進捗情報を`UI.html`に返します。
15. **`UI.html`**:
    - 進捗バーを更新し、処理状況を表示します。
    - `processing`の場合は次のジョブ処理を継続します。
    - `complete`の場合は完了メッセージと結果ファイルのリンクを表示します。

### フェーズ3: 完了処理

16. **`History`**: 全ジョブ完了時に翻訳結果のサマリーを履歴用スプレッドシートに記録します。
17. **`UI.html`**: 最終結果をユーザーに表示し、履歴を更新します。

## 注意点

- **機密情報**: APIキーはGASの「スクリプトプロパティ」で安全に管理されています。
- **外部API**: OpenAI API (`https://api.openai.com/v1/chat/completions`) を利用しています。
- **データストア**: 翻訳履歴と辞書データは、ユーザーのGoogle Drive内に自動生成されるGoogleスプレッドシートに保存されます。
- **Queue方式の技術的制約**:
  - **キャッシュ依存**: タスク情報は`CacheService.getUserCache()`に6時間保存されます。キャッシュが期限切れになると処理が中断されます。
  - **非同期処理**: フロントエンドが定期的にバックエンドを呼び出す仕組みのため、ブラウザを閉じると処理が中断されます。
- **GASの制約対応**:
  - **実行時間制限回避**: Queue方式により、6分の実行時間制限を回避しています。
  - **メモリ効率**: 一度に1つのジョブのみを処理することで、メモリ使用量を最小化しています。