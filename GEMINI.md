# Geminiのためのプロジェクトドキュメント

## プロジェクト名

Google Drive 翻訳ツール

## プロジェクト概要

このプロジェクトは、Google Apps Script（GAS）で構築された、Google Drive上のファイルをAIで翻訳するツールです。Google スプレッドシート、ドキュメント、プレゼンテーションに対応しています。最大の特徴は、**AI駆動の辞書学習システム**であり、翻訳を実行するたびに自動で辞書を拡充し、継続的に翻訳品質を向上させます。OpenAIの`gpt-4.1-mini`モデルの特性を最大限に活用するよう設計されています。

## 設計思想

- **LLMとの明確な役割分担**: LLMの創造的タスク（高品質な翻訳）と分析的タスク（用語ペアの抽出）を分離し、後者の判定（新規か否か）はシステム側が担うことで、全体の信頼性を向上させています。
- **gpt-4.1-miniへの最適化**: 長いコンテキストを扱うLLMのクセを考慮し、指示とデータをXML形式で構造化して渡す「XMLベースプロンプト」を採用。これにより、LLMが文脈の境界を明確に認識し、指示の無視や翻訳漏れといった問題を根本的に解決しています。
- **拡張性の高いハンドラ設計**: ファイル操作を、司令塔となる`FileHandler`と、各形式に特化した`SpreadsheetHandler`, `DocumentHandler`, `PresentationHandler`に分離。これにより、将来的なファイル形式の追加が容易になっています。
- **堅牢性と信頼性**: Queue方式の非同期処理により、GASの実行時間制限（6分）を回避し、大容量ファイルでも安定して処理できるように設計されています。

## プロジェクト構成

- **`Code.gs`**: メインファイル。UIを提供し、フロントエンドからの非同期リクエストを管理するQueue処理のオーケストレーターです。
- **`Config.gs`**: 設定ファイル。APIキーやスプレッドシートIDなどを管理します。
- **`FileHandler.gs`**: **[司令塔]** ファイル種別を判断し、適切なハンドラに処理を委譲する役割に特化。
- **`SpreadsheetHandler.gs`**: **[新設]** スプレッドシートのジョブ分割（セル単位）と書き込み処理を担当。
- **`DocumentHandler.gs`**: **[新設]** ドキュメントのジョブ分割（段落単位）と書き込み処理を担当。
- **`PresentationHandler.gs`**: **[新設]** プレゼンテーションのジョブ分割（テキスト要素単位）と書き込み処理を担当。
- **`Translator.gs`**: **[大幅強化]** `gpt-4.1-mini`に最適化されたXMLプロンプトを生成し、翻訳と全用語ペアの抽出を指示する、システムの中核エンジン。
- **`TermExtractor.gs` / `TermMatcher.gs`**: 翻訳前の辞書適用判断のため、テキストからキーワードを抽出・照合する補助エンジン。
- **`Dictionary.gs` / `DictionaryQualityManager.gs`**: 辞書データのCRUD、キャッシュ管理、およびLLMが生成した全用語ペアから「新規ペア」を判定・登録する品質管理を担当。
- **`History.gs`**: 翻訳履歴を記録・管理します。
- **`Utils.gs`**: **[機能追加]** `escapeXml`など、プロジェクト全体で利用するヘルパー関数を提供。
- **`UI.html`**: フロントエンドSPA。

## 主なワークフロー：XMLベースの学習・翻訳ループ

### フェーズ1: 翻訳ジョブのセットアップ

1.  **UI** → **`Code.gs`**: ユーザーがファイルURLを指定し、翻訳を開始。
2.  **`FileHandler`**: ファイル種別を特定し、適切なハンドラ（`DocumentHandler`など）を呼び出す。
3.  **`DocumentHandler`**: ファイルを個別のジョブ（例：段落単位）に分割する。
4.  **`Code.gs`**: 生成されたジョブリストをキャッシュに保存し、UIにタスクIDを返す。

### フェーズ2: 非同期学習・翻訳ループ

5.  **UI** → **`Code.gs`**: `processNextInQueue`を繰り返し呼び出し、ジョブを1件ずつ処理。
6.  **`TermExtractor` & `TermMatcher`**: 現在のジョブのテキストからキーワードを抽出し、既存辞書と照合して「確定ペア」のリストを作成する。
7.  **`Translator`**: **最重要プロセス**
    a.  確定ペアと原文テキストを**XML形式**で構造化した、`gpt-4.1-mini`に最適化されたプロンプトを生成する。
    b.  LLMにXMLプロンプトを送信し、「翻訳」と「翻訳で使った全名詞・固有名詞ペアの報告」を同時に指示する。
8.  **LLM**: XML構造を理解し、辞書ルールを厳格に守りながら翻訳を実行。結果をJSON（`translations`と`term_pairs`）で返す。
9.  **`DictionaryQualityManager` & `Dictionary`**: LLMが返した`term_pairs`（全ペア）と既存辞書を比較し、差分（新規ペア）のみをフィルタリングして辞書に登録する。
10. **`DocumentHandler`**: 翻訳結果を元のファイル（段落など）に書き込む。
11. **`Code.gs`** → **UI**: 進捗を更新し、次のジョブに進む。

### フェーズ3: 完了処理

12. **`History`**: 全ジョブ完了時に翻訳サマリーを記録。
13. **`UI`**: 最終結果をユーザーに表示。
