# Geminiのためのプロジェクトドキュメント

## プロジェクト名

Google Drive 翻訳ツール

## プロジェクト概要

このプロジェクトは、Google Apps Script（GAS）で構築された、Google Drive上のファイルをAI（OpenAI `gpt-4o-mini`）で翻訳するツールです。Google スプレッドシート、ドキュメント、プレゼンテーションに対応しており、カスタム辞書機能と翻訳履歴管理機能を備えています。

## 設計思想

- **モジュール性**: `FileHandler`, `Translator`, `Dictionary`, `History`といったクラスベースの設計を採用し、各機能の関心を分離しています。これにより、保守性と拡張性を高めています。
- **設定の集中管理**: `Config.gs`にAPIキー、モデル名、各種IDなどの設定を集約し、環境ごとの設定変更を容易にしています。
- **ユーザー中心**: 専門知識がなくても使えるWeb UIを提供し、辞書機能を通じてユーザーが翻訳品質をコントロールできるようにしています。
- **堅牢性**: エラーハンドリングとリトライ機構を備え、安定した動作を目指しています。

## プロジェクト構成

- **`Code.gs`**: メインファイル。`doGet`でUIを提供し、フロントエンドからのリクエストを処理するサーバーサイド関数のエントリーポイントです。
- **`Config.gs`**: 設定ファイル。APIキーやスプレッドシートIDなどを管理します。初回実行時に必要なスプレッドシートを自動生成するロジックも含まれています。
- **`FileHandler.gs`**: ファイル操作クラス。Google Drive上のファイルの読み込み、コンテンツ（テキスト、スタイル）の抽出、翻訳済みファイルの作成を担当します。
- **`Translator.gs`**: 翻訳処理クラス。OpenAI APIと通信し、テキストの翻訳を実行します。テキストをAPIの制限に合わせたチャンクに分割するロジックも持ちます。
- **`Dictionary.gs`**: 辞書管理クラス。Googleスプレッドシートをデータベースとして利用し、辞書のCRUD操作やキャッシュ管理を行います。
- **`History.gs`**: 履歴管理クラス。翻訳結果をスプレッドシートに記録し、統計情報を生成します。
- **`UI.html`**: フロントエンド。HTML, CSS, JavaScriptで構成されたシングルページアプリケーションです。`google.script.run`を介してGASのバックエンド関数を呼び出します。

## 主なワークフロー：ファイル翻訳

1.  **UI**: ユーザーがファイルURLを入力し、「翻訳を開始」ボタンをクリックします。
2.  **`UI.html`**: `google.script.run`を使い、`translateFile`関数（`Code.gs`内）を呼び出します。
3.  **`Code.gs`**: `translateFile`関数がリクエストを受け取ります。
4.  **`FileHandler`**: `getFileInfo`メソッドでファイルの内容とメタデータを抽出します。
5.  **`Translator`**: `translateFile`メソッドが呼び出されます。
    - ファイルタイプに応じて、テキストをバッチ処理用の配列にまとめます。
    - `translateBatch`メソッドで、テキストをAPIの文字数制限に合わせてチャンクに分割します。
    - `translateChunk`メソッドで、各チャンクを翻訳します。
        - **`Dictionary`**: `getBatchTerms`で辞書データを取得します。
        - **`callOpenAI`**: 辞書データを含むプロンプトを生成し、OpenAI APIにリクエストを送信します。
6.  **`FileHandler`**: `createTranslatedFile`メソッドで、翻訳されたコンテンツから新しいGoogle Driveファイルを作成します。
7.  **`History`**: `record`メソッドで、翻訳ジョブの結果をスプレッドシートに記録します。
8.  **`Code.gs`**: 処理結果（成功/失敗、新しいファイルURLなど）を`UI.html`に返します。
9.  **UI**: 結果をユーザーに表示します。

## 注意点

- **機密情報**: APIキーなどの機密情報は、GASの「スクリプトプロパティ」で管理されています。コード内には直接記述されていません。
- **外部API**: OpenAI API (`https://api.openai.com/v1/chat/completions`) を利用しています。
- **データストア**: 翻訳履歴と辞書データは、ユーザーのGoogle Drive内に自動生成されるGoogleスプレッドシートに保存されます。
- **GASの制約**: 実行時間制限（最大6分）やAPIコール数のクォータなど、Google Apps Scriptの制約下で動作するように設計されています。
