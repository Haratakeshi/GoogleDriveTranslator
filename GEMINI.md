# Geminiのためのプロジェクトドキュメント

## プロジェクト名

Google Drive 翻訳ツール

## プロジェクト概要

このプロジェクトは、Google Apps Script（GAS）で構築された、Google Drive上のファイルをAI（OpenAI `gpt-4o-mini`）で翻訳するツールです。Google スプレッドシート、ドキュメント、プレゼンテーションに対応しており、カスタム辞書機能と翻訳履歴管理機能を備えています。

## 設計思想

- **モジュール性**: `FileHandler`, `Translator`, `Dictionary`, `History`といったクラスベースの設計を採用し、各機能の関心を分離しています。これにより、保守性と拡張性を高めています。
- **設定の集中管理**: `Config.gs`にAPIキー、モデル名、各種IDなどの設定を集約し、環境ごとの設定変更を容易にしています。
- **ユーザー中心**: 専門知識がなくても使えるWeb UIを提供し、辞書機能を通じてユーザーが翻訳品質をコントロールできるようにしています。
- **堅牢性**: エラーハンドリングとリトライ機構を備え、安定した動作を目指しています。

## プロジェクト構成

- **`Code.gs`**: メインファイル。`doGet`でUIを提供し、フロントエンドからのリクエストを処理するサーバーサイド関数のエントリーポイントです。
- **`Config.gs`**: 設定ファイル。APIキーやスプレッドシートIDなどを管理します。初回実行時に必要なスプレッドシートを自動生成するロジックも含まれています。
- **`FileHandler.gs`**: ファイル操作クラス。Google Drive上のファイルの読み込み、コンテンツ（テキスト、スタイル）の抽出、翻訳済みファイルの作成を担当します。
- **`Translator.gs`**: 翻訳処理クラス。OpenAI APIと通信し、テキストの翻訳を実行します。テキストをAPIの制限に合わせたチャンクに分割するロジックも持ちます。
- **`Dictionary.gs`**: 辞書管理クラス。Googleスプレッドシートをデータベースとして利用し、辞書のCRUD操作やキャッシュ管理を行います。
- **`History.gs`**: 履歴管理クラス。翻訳結果をスプレッドシートに記録し、統計情報を生成します。
- **`UI.html`**: フロントエンド。HTML, CSS, JavaScriptで構成されたシングルページアプリケーションです。`google.script.run`を介してGASのバックエンド関数を呼び出します。

## 主なワークフロー：Queue方式ファイル翻訳

### フェーズ1: 翻訳ジョブのセットアップ

1.  **UI**: ユーザーがファイルURLを入力し、「翻訳を開始」ボタンをクリックします。
2.  **`UI.html`**: `google.script.run`を使い、`setupTranslationQueue`関数（`Code.gs`内）を呼び出します。
3.  **`Code.gs`**: `setupTranslationQueue`関数がリクエストを受け取ります。
4.  **`FileHandler`**:
    - `getFileInfo`メソッドでファイルの基本情報を取得します。
    - `createEmptyTranslatedFile`メソッドで翻訳先の空ファイルを事前作成します。
    - `createTranslationJobs`メソッドでファイルを個別のジョブ（セル単位）に分割します。
5.  **`Code.gs`**:
    - タスクIDを生成し、ジョブ情報をキャッシュに保存します。
    - セットアップ結果（タスクID、総ジョブ数、翻訳先ファイルURL）を`UI.html`に返します。

### フェーズ2: 非同期ジョブ処理

6.  **`UI.html`**: セットアップ完了後、`processNextInQueue`関数を繰り返し呼び出します。
7.  **`Code.gs`**: `processNextInQueue`関数が1つのジョブを処理します。
    - キャッシュからタスク情報を取得し、次のジョブを取り出します。
8.  **`Translator`**: `translateText`メソッドで個別のテキストを翻訳します。
    - **`Dictionary`**: `getBatchTerms`で辞書データを取得します。
    - **`callOpenAI`**: 辞書データを含むプロンプトを生成し、OpenAI APIにリクエストを送信します。
9.  **`FileHandler`**: `writeTranslatedJob`メソッドで翻訳結果を即座にファイルに書き込みます。
10. **`Code.gs`**: 処理状況（processing/complete/error）と進捗情報を`UI.html`に返します。
11. **`UI.html`**:
    - 進捗バーを更新し、処理状況を表示します。
    - `processing`の場合は次のジョブ処理を継続します。
    - `complete`の場合は完了メッセージと結果ファイルのリンクを表示します。

### フェーズ3: 完了処理

12. **`History`**: 全ジョブ完了時に翻訳結果をスプレッドシートに記録します。
13. **`UI.html`**: 最終結果をユーザーに表示し、履歴を更新します。

## 注意点

- **機密情報**: APIキーなどの機密情報は、GASの「スクリプトプロパティ」で管理されています。コード内には直接記述されていません。
- **外部API**: OpenAI API (`https://api.openai.com/v1/chat/completions`) を利用しています。
- **データストア**: 翻訳履歴と辞書データは、ユーザーのGoogle Drive内に自動生成されるGoogleスプレッドシートに保存されます。
- **Queue方式の技術的制約**:
  - **キャッシュ依存**: タスク情報は`CacheService.getUserCache()`に6時間保存されます。キャッシュが期限切れになると処理が中断されます。
  - **ジョブ単位処理**: 現在はスプレッドシートのセル単位でのみジョブ分割が実装されています（ドキュメント・プレゼンテーションは未実装）。
  - **非同期処理**: フロントエンドが定期的にバックエンドを呼び出す仕組みのため、ブラウザを閉じると処理が中断されます。
- **GASの制約対応**:
  - **実行時間制限回避**: Queue方式により、6分の実行時間制限を回避しています。
  - **メモリ効率**: 一度に1つのジョブのみを処理することで、メモリ使用量を最小化しています。
