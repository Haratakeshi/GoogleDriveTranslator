# Google Drive 翻訳ツール

## 概要

このGoogle Apps Script（GAS）プロジェクトは、Google Drive上のファイル（スプレッドシート、ドキュメント、プレゼンテーション）を、OpenAIのLLM（`gpt-4.1-mini`）を活用して翻訳するためのWebアプリケーションです。

最大の特徴は、**AI駆動の辞書学習システム**です。翻訳を実行するたびに、AIが文脈から重要な用語ペアを自動で抽出し、辞書を継続的に拡充。使えば使うほど、専門用語の翻訳精度や一貫性が向上していきます。

## 主な機能

### 🔥 AI辞書学習システム
- **高精度な用語ペア抽出**: 翻訳プロセスで、AIが重要と判断した名詞・固有名詞のペアを自動で抽出します。
- **システムによる重複排除**: 抽出されたペアが既存辞書にあるかをシステムが確実に判定し、真に新しい用語のみを登録候補とします。
- **リアルタイム辞書更新**: 翻訳完了後、新しい用語ペアは即座に辞書に登録され、次の翻訳からすぐに活用できます。

### 📄 多形式ファイル対応の拡張
- **Google スプレッドシート**: セル単位での学習・翻訳を実現。
- **Google ドキュメント**: 段落単位での学習・翻訳に対応。 **（NEW!）**
- **Google プレゼンテーション**: テキストボックス単位での学習・翻訳に対応。 **（NEW!）**
- **Queue方式の非同期処理**で、あらゆる形式の大容量ファイルも安定して処理します。

### 🧠 高品質・高信頼性な翻訳
- **gpt-4.1-mini最適化プロンプト**: LLMの特性を考慮し、指示とデータをXML形式で構造化。これにより、LLMが文脈の境界を明確に認識し、翻訳の失敗（指示の無視や部分的な翻訳）を劇的に削減しました。
- **辞書ルールの絶対遵守**: 「翻訳しない」と辞書に登録された単語（例：固有名詞）は、LLMの判断に左右されることなく、確実に原文のまま維持されます。

### 📚 カスタム辞書機能
- ユーザーが独自の辞書を作成・管理可能。
- 辞書のインポート/エクスポート機能（JSON形式）。

### 📊 翻訳履歴と統計
- 過去の翻訳ジョブ、言語、文字数、処理時間などを自動で記録・一覧化。
- 翻訳回数や推定APIコストなどを可視化し、コスト管理を支援します。

## 設計思想

1.  **LLMとの明確な役割分担**:
    - **LLMの責務**: 文脈を理解し、高品質な翻訳を生成すること。および、その翻訳から重要な用語ペアを機械的にすべて抜き出すこと。
    - **システムの責務**: LLMが抽出した全ペアと既存辞書を比較し、差分（新規ペア）を確実に判定すること。
    - この明確な役割分担により、LLMの負荷を軽減し、学習機能の信頼性を飛躍的に向上させています。

2.  **拡張性と保守性**:
    - ファイル操作ロジックを`FileHandler.gs`（司令塔）と、各形式専用のハンドラ（`SpreadsheetHandler.gs`等）に分離。これにより、新しいファイル形式への対応が容易になっています。
    - 設定値は`Config.gs`に集約。

3.  **堅牢性と信頼性**:
    - `gpt-4.1-mini`のクセを考慮したXMLベースのプロンプトエンジニアリングにより、LLMの誤動作を最小化。
    - Queue方式の非同期処理で、GASの実行時間制限（6分）を回避。

## AI辞書学習システムの詳細

### 🔄 学習ワークフロー

```
1. 翻訳ジョブをファイル形式に応じて分割（セル、段落、テキストボックス単位）

2. 個々のジョブで、以下のループを実行:
   a) 既存辞書と原文から、LLMへの指示（XML形式）を生成
   b) LLMがXMLを解釈し、辞書ルールを遵守しながら翻訳を実行
   c) LLMが翻訳文から「すべての名詞・固有名詞ペア」を報告
   d) システムが報告された全ペアと既存辞書を比較し、「新規ペア」を特定
   e) 品質フィルタ（例：原文と訳文が同じペアを除外）を通過したものを辞書に自動登録

3. 次のジョブでは、更新された最新の辞書が利用される
```

### 🧩 システム構成要素

- **TermExtractor**: テキストから辞書照合用のキーワードを抽出するエンジン。
- **TermMatcher**: 抽出されたキーワードと既存辞書を照合するエンジン。
- **Translator**: **(大幅強化)** `gpt-4.1-mini`に最適化されたXMLプロンプトを生成し、翻訳と全用語ペアの抽出を指示する、システムの中核。
- **Dictionary**: 辞書データのCRUDとキャッシュを管理。
- **DictionaryQualityManager**: LLMが生成したペアの品質をチェックし、登録可否を判断。

## プロジェクト構成

```
/
├── Code.gs                      # メインロジック、非同期Queue処理
├── Config.gs                    # 設定ファイル、初期化処理
├── Dictionary.gs                # 辞書CRUD操作、キャッシュ管理
├── DictionaryQualityManager.gs  # 用語品質評価・管理
├── FileHandler.gs               # 【司令塔】ファイル種別を判断し、適切なハンドラに処理を委譲
├── SpreadsheetHandler.gs        # 【新設】スプレッドシートのジョブ分割・書き込み処理
├── DocumentHandler.gs           # 【新設】ドキュメントのジョブ分割・書き込み処理
├── PresentationHandler.gs       # 【新設】プレゼンテーションのジョブ分割・書き込み処理
├── History.gs                   # 翻訳履歴記録・統計
├── TermExtractor.gs             # AI用語抽出エンジン
├── TermMatcher.gs               # 辞書照合エンジン
├── Translator.gs                # 【大幅強化】XMLベースのプロンプト生成、翻訳実行、用語ペア抽出
├── Utils.gs                     # 【機能追加】XMLエスケープ等のユーティリティ関数
└── UI.html                      # フロントエンドUI
```

(セットアップとデプロイ方法は変更ありません)
