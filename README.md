# Google Drive 翻訳ツール

## 概要

このGoogle Apps Script（GAS）プロジェクトは、Google Drive上のファイル（スプレッドシート、ドキュメント、プレゼンテーション）を、OpenAIのLLM（`gpt-4.1-mini`）を活用して翻訳するためのWebアプリケーションです。

ユーザーフレンドリーなUIを備え、**AI駆動の辞書学習機能**により翻訳品質が段階的に向上する革新的な翻訳システムを提供します。

## 主な機能

### 🔥 AI辞書学習システム（新機能）
- **1件ずつの段階的学習**: 翻訳するたびに辞書が自動で充実し、翻訳品質が向上
- **インテリジェント用語抽出**: 短いテキストや記号付きテキストからも重要用語を抽出
- **自動辞書マッチング**: 抽出した用語と既存辞書を照合し、一致する場合は確実に適用
- **品質フィルタリング**: 無意味な用語ペア（未翻訳、記号のみ）を自動除外
- **リアルタイム辞書更新**: 翻訳完了後に新規用語を即座に辞書登録

### 📄 多形式ファイル対応
- Google スプレッドシート、ドキュメント、プレゼンテーションの翻訳に対応
- **Queue方式の非同期処理**で大容量ファイルも安定処理

### 🧠 高品質な翻訳
- OpenAIの最新モデル（gpt-4.1-mini）を利用
- **辞書強制適用システム**で専門用語の翻訳精度を保証
- 1件ずつの翻訳で文脈を考慮した自然な翻訳を実現

### 📚 カスタム辞書機能
- ユーザーが独自の辞書を作成・管理可能
- 辞書のインポート/エクスポート機能（JSON形式）
- **自動用語蓄積**により手動登録の負担を大幅削減

### 📊 翻訳履歴管理
- 過去の翻訳ジョブを自動で記録
- 翻訳元/先のファイル、言語、文字数、処理時間などを一覧で確認可能

### 📈 統計ダッシュボード
- 翻訳回数、総文字数、推定APIコストなどを可視化
- 利用状況を分析し、コスト管理に役立てることが可能

### 🎨 直感的なWeb UI
- ファイルURLを入力し、言語と辞書を選択するだけの簡単操作
- 翻訳、履歴、辞書管理、統計の各機能がタブで整理されたインターフェース
- リアルタイム進捗表示

## 設計思想

このツールは、以下の思想に基づいて設計されています。

1.  **AI駆動の継続的学習**:
    - 翻訳するたびに辞書が自動で成長し、翻訳品質が向上
    - 用語抽出、辞書照合、自動登録の完全自動化
    - ユーザーの手間を最小化しながら最大の翻訳品質を実現

2.  **拡張性と保守性**:
    - 各機能をクラス（`FileHandler`, `Translator`, `Dictionary`, `TermExtractor`, `TermMatcher`）に分割
    - 設定値は`Config.gs`に集約し、変更を容易に
    - 新しいファイル形式や翻訳エンジンへの対応も、関連クラスの修正で実現可能

3.  **ユーザー中心設計**:
    - コーディング知識がなくても使える直感的なWeb UIを提供
    - 翻訳プロセスを可視化し、結果をすぐに確認できるフィードバックループ
    - 辞書機能により、ユーザー自身が翻訳品質をカスタマイズできる

4.  **堅牢性と信頼性**:
    - APIエラーやファイルアクセスエラーに対する詳細なエラーハンドリングを実装
    - 翻訳ジョブの成功・失敗を問わず履歴に記録し、問題追跡を容易に
    - **Queue方式による非同期処理**で、大容量ファイルでも安定した翻訳処理を実現

5.  **パフォーマンスと効率性**:
    - 辞書データをキャッシュし、スプレッドシートへのアクセスを最小化
    - **ジョブベースの翻訳処理**により、個別のセルやテキスト単位での細かな制御が可能
    - **リアルタイム進捗表示**により、処理状況を視覚的に確認できる

6.  **スケーラビリティ**:
    - **非同期Queue処理**により、GASの実行時間制限（6分）を回避
    - 大容量ファイルでも段階的に処理し、途中でエラーが発生しても処理を継続

## AI辞書学習システムの詳細

### 🔄 学習ワークフロー

```
1. 翻訳テキストから重要用語を自動抽出
   例: "【依頼内容】" → ["依頼", "内容"]

2. 抽出用語と既存辞書を照合
   例: "プラットフォーム" が辞書にある場合は確定ペアとして使用

3. LLM翻訳で新規用語ペアを生成
   例: {"source": "画像制作", "target": "图片制作"}

4. 品質フィルターで有効なペアのみを選別
   ❌ "依頼内容" -> "依頼内容" (未翻訳)
   ✅ "プラットフォーム" -> "平台" (有効)

5. 新規用語を辞書に自動登録
   次回翻訳時から即座に活用可能
```

### 🧩 システム構成要素

- **TermExtractor**: AI用語抽出エンジン（GPT-4.1-mini使用）
- **TermMatcher**: 高速辞書照合システム
- **Translator**: 辞書強制適用翻訳エンジン（GPT-4.1-mini使用）
- **DictionaryQualityManager**: 用語品質管理システム

### 📊 学習効果

- **初回翻訳**: 辞書なし → 基本的な翻訳品質
- **2回目以降**: 蓄積された用語を活用 → 専門用語の翻訳精度向上
- **長期利用**: 大量の用語ペア蓄積 → 高品質で一貫性のある翻訳

## プロジェクト構成

```
/
├── Code.gs                      # メインロジック、非同期Queue処理
├── Config.gs                    # 設定ファイル、初期化処理
├── Dictionary.gs                # 辞書CRUD操作、キャッシュ管理
├── DictionaryQualityManager.gs  # 用語品質評価・管理
├── FileHandler.gs               # ファイル操作、ジョブ分割
├── History.gs                   # 翻訳履歴記録・統計
├── TermExtractor.gs             # AI用語抽出エンジン
├── TermMatcher.gs               # 辞書照合エンジン
├── Translator.gs                # 翻訳処理、自動辞書登録
├── Utils.gs                     # ユーティリティ関数
└── UI.html                      # フロントエンドUI
```

### 各ファイルの役割

- **`Code.gs`**:
    - **1件ずつの翻訳処理**を管理する`processNextInQueue`関数
    - 用語抽出・辞書照合・翻訳・辞書登録の統合ワークフロー

- **`TermExtractor.gs`** 🆕:
    - OpenAI APIを使用した高精度な用語抽出
    - 短いテキストや記号付きテキストに特化した抽出ロジック
    - 品質フィルタリングで有効な用語のみを選別

- **`TermMatcher.gs`** 🆕:
    - 抽出用語と辞書の高速照合システム
    - 完全一致、正規化一致、部分一致、あいまい一致に対応

- **`Translator.gs`** 🔄:
    - 辞書強制適用システムで専門用語の翻訳精度を保証
    - 新規用語ペアの自動生成・登録機能
    - 無効な用語ペア（未翻訳、記号のみ）の自動除外

- **`Dictionary.gs`** 🔄:
    - 自動用語登録機能で辞書が段階的に成長
    - 重複チェック機能で辞書の品質を維持
    - キャッシュ自動更新で最新辞書データを即座に反映

- **`DictionaryQualityManager.gs`** 🆕:
    - 新規用語の品質評価・スコアリング
    - 用語の重要度判定と自動承認/却下

## セットアップとデプロイ

### 1. スクリプトプロパティの設定

1.  GASエディタの左メニューから「プロジェクトの設定」（歯車アイコン）を開く
2.  「スクリプト プロパティ」セクションで、以下のキーと値を設定:
    - `OPENAI_API_KEY`: あなたのOpenAI APIキー
    - `OPENAI_ORGANIZATION_ID`: あなたのOpenAI Organization ID
    - `OPENAI_PROJECT_ID`: あなたのOpenAI Project ID

### 2. 初回セットアップ

1.  GASエディタで`Code.gs`を開き、関数一覧から`setupApplication`を選択して実行
2.  承認プロンプトが表示されたら、必要な権限を許可
3.  履歴と辞書用のスプレッドシートが自動作成される

### 3. デプロイ

1.  GASエディタ右上の「デプロイ」ボタンをクリックし、「新しいデプロイ」を選択
2.  種類の選択で「ウェブアプリ」を選択
3.  以下の設定でデプロイ:
    - **ウェブアプリを実行するユーザー**: 自分
    - **アクセスできるユーザー**: （セキュリティ要件に合わせて選択）
4.  生成されたURLにアクセスしてツールを利用

## 翻訳処理の仕組み（1件ずつ学習型）

### 概要

本ツールは、**1件ずつの段階的学習方式**を採用し、翻訳するたびに辞書が自動で成長する革新的なシステムです。

### 処理フロー

1. **翻訳ジョブのセットアップ**
   - ファイルを個別のジョブ（セル単位）に分割
   - 翻訳先の空ファイルを事前作成

2. **1件ずつの学習型翻訳処理**
   ```
   for each job:
     a) 現在のジョブテキストから用語抽出
     b) 抽出用語と最新辞書を照合
     c) 確定ペアを使用してLLM翻訳
     d) 新規用語ペアを辞書に自動登録
     e) 辞書データを更新（次のジョブで利用可能）
   ```

3. **リアルタイム品質向上**
   - 処理が進むほど辞書が充実
   - 後半のジョブほど高品質な翻訳を実現
   - 同一ファイル内での翻訳一貫性を保証

### 技術的詳細

- **用語抽出**: GPT-4.1-miniによる高精度な用語認識
- **辞書照合**: O(1)の高速ハッシュマップ検索
- **翻訳強制適用**: 確定用語の100%適用保証
- **自動品質管理**: 無効ペアの自動除外
- **キャッシュ管理**: 辞書更新の即座反映

### 利点

- **継続的品質向上**: 使うほど翻訳が上達
- **専門用語対応**: 分野特有の用語を自動学習
- **一貫性保証**: 同一用語の統一翻訳
- **運用負荷軽減**: 手動辞書メンテナンス不要

## デバッグ機能

システムの動作状況を詳細に確認できる包括的なログ出力機能を搭載:

- **用語抽出ログ**: API生レスポンス、抽出結果詳細をJSON出力
- **辞書照合ログ**: マッチング結果、確定ペア数を詳細表示
- **翻訳結果ログ**: 翻訳API生レスポンス、最終結果をJSON出力
- **辞書登録ログ**: 新規用語の登録状況、重複スキップ状況を表示

## 今後の展望

- 対応ファイル形式の追加（PDF、テキストファイルなど）
- 多言語間翻訳対応（日→英→中など）
- 他のLLM（Gemini, Claudeなど）への対応
- 用語抽出精度のさらなる向上
- 辞書の自動カテゴライズ機能