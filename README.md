# Google Drive 翻訳ツール

## 概要

このGoogle Apps Script（GAS）プロジェクトは、Google Drive上のファイル（スプレッドシート、ドキュメント、プレゼンテーション）を、OpenAIのLLM（`gpt-4o-mini`）を活用して翻訳するためのWebアプリケーションです。

ユーザーフレンドリーなUIを備え、専門用語の翻訳精度を向上させるための辞書機能や、過去の翻訳履歴を確認できる機能を提供します。

## 主な機能

- **多形式ファイル対応**: Google スプレッドシート、ドキュメント、プレゼンテーションの翻訳に対応。
- **高品質な翻訳**: OpenAIの最新モデルを利用し、自然で正確な翻訳を実現。
- **カスタム辞書機能**:
    - ユーザーが独自の辞書を作成・管理可能。
    - 辞書に登録した用語は翻訳時に優先的に適用され、専門分野の翻訳精度が向上。
    - 辞書のインポート/エクスポート機能（JSON形式）。
- **翻訳履歴管理**:
    - 過去の翻訳ジョブを自動で記録。
    - 翻訳元/先のファイル、言語、文字数、処理時間などを一覧で確認可能。
- **統計ダッシュボード**:
    - 翻訳回数、総文字数、推定APIコストなどを可視化。
    - 利用状況を分析し、コスト管理に役立てることが可能。
- **直感的なWeb UI**:
    - ファイルURLを入力し、言語と辞書を選択するだけの簡単操作。
    - 翻訳、履歴、辞書管理、統計の各機能がタブで整理されたインターフェース。

## 設計思想

このツールは、以下の思想に基づいて設計されています。

1.  **拡張性と保守性**:
    - 各機能をクラス（`FileHandler`, `Translator`, `Dictionary`, `History`）に分割し、関心事を分離。
    - 設定値は`Config.gs`に集約し、変更を容易に。
    - 新しいファイル形式や翻訳エンジンへの対応も、関連クラスの修正で実現可能。

2.  **ユーザー中心設計**:
    - コーディング知識がなくても使える直感的なWeb UIを提供。
    - 翻訳プロセスを可視化し、結果をすぐに確認できるフィードバックループ。
    - 辞書機能により、ユーザー自身が翻訳品質をカスタマイズできる。

3.  **堅牢性と信頼性**:
    - APIエラーやファイルアクセスエラーに対する詳細なエラーハンドリングを実装。
    - 翻訳ジョブの成功・失敗を問わず履歴に記録し、問題追跡を容易に。
    - **Queue方式による非同期処理**で、大容量ファイルでも安定した翻訳処理を実現。

4.  **パフォーマンスと効率性**:
    - 辞書データをキャッシュし、スプレッドシートへのアクセスを最小化。
    - **ジョブベースの翻訳処理**により、個別のセルやテキスト単位での細かな制御が可能。
    - **リアルタイム進捗表示**により、処理状況を視覚的に確認できる。

5.  **スケーラビリティ**:
    - **非同期Queue処理**により、GASの実行時間制限（6分）を回避。
    - 大容量ファイルでも段階的に処理し、途中でエラーが発生しても処理を継続。

## プロジェクト構成

```
/
├── Code.gs             # メインロジック、サーバーサイド関数のエントリーポイント
├── Config.gs           # APIキー、モデル名、スプレッドシートIDなどの設定ファイル
├── Dictionary.gs       # 辞書機能（作成、検索、インポート/エクスポート）を管理するクラス
├── FileHandler.gs      # Google Driveファイルの読み書き、コンテンツ抽出を管理するクラス
├── History.gs          # 翻訳履歴の記録と取得を管理するクラス
├── Translator.gs       # OpenAI APIとの連携、翻訳処理の実行を管理するクラス
└── UI.html             # フロントエンドのHTML、CSS、JavaScript
```

### 各ファイルの役割

- **`Code.gs`**:
    - Webアプリの`doGet`関数を定義し、UIを表示するエントリーポイント。
    - **Queue方式の翻訳処理**を管理する`setupTranslationQueue`と`processNextInQueue`関数を提供。
    - `UI.html`から呼び出されるサーバーサイド関数（辞書管理、履歴取得など）の窓口。
- **`Config.gs`**:
    - スクリプトプロパティからAPIキーなどの機密情報を取得。
    - アプリケーション全体で使用する定数（対応言語、ファイル形式、エラーメッセージなど）を定義。
    - 初回実行時に履歴と辞書用のスプレッドシートを自動作成するロジックを含む。
- **`FileHandler.gs`**:
    - 指定されたファイルIDに基づき、ファイル形式（Spreadsheet, Document, Presentation）を判別。
    - **ジョブベースの翻訳処理**のため、ファイルを個別のジョブ（セル単位）に分割する`createTranslationJobs`機能。
    - 翻訳先の空ファイルを事前作成し、各ジョブの翻訳結果を段階的に書き込む仕組み。
- **`Translator.gs`**:
    - **単一テキストの翻訳**に特化した`translateText`メソッドを提供。
    - 辞書データをプロンプトに含め、OpenAI APIにリクエストを送信。
    - JSON形式での構造化された翻訳リクエスト・レスポンス処理。
- **`Dictionary.gs`**:
    - 辞書データが格納されたGoogleスプレッドシートを操作。
    - 辞書のCRUD（作成、読み取り、更新、削除）機能を提供。
    - パフォーマンス向上のため、辞書データを一時的にキャッシュ。
- **`History.gs`**:
    - 翻訳ジョブの詳細（日時、ファイル情報、結果、エラーなど）をGoogleスプレッドシートに記録。
    - UIに表示するための履歴データを取得。
    - 日次での利用統計をサマリーシートに記録。
- **`UI.html`**:
    - HTML、CSS、JavaScriptで構成されたシングルページのWebアプリケーション。
    - **非同期Queue処理**に対応したリアルタイム進捗表示機能。
    - `google.script.run`を使用してサーバーサイドのGAS関数を非同期に呼び出す。
    - 翻訳の進捗表示、結果のフィードバック、各種データの表示など、動的なUIを構築。

## セットアップとデプロイ

### 1. スクリプトプロパティの設定

1.  GASエディタの左メニューから「プロジェクトの設定」（歯車アイコン）を開く。
2.  「スクリプト プロパティ」セクションで、以下のキーと値を設定します。
    - `OPENAI_API_KEY`: あなたのOpenAI APIキー
    - `OPENAI_ORGANIZATION_ID`: あなたのOpenAI Organization ID
    - `OPENAI_PROJECT_ID`: あなたのOpenAI Project ID

### 2. 初回セットアップ

1.  GASエディタで`Code.gs`を開き、関数一覧から`setupApplication`を選択して実行します。
2.  承認プロンプトが表示されたら、必要な権限を許可します。
3.  これにより、APIの利用に必要な権限が付与され、履歴と辞書用のスプレッドシートが自動で作成されます。

### 3. デプロイ

1.  GASエディタ右上の「デプロイ」ボタンをクリックし、「新しいデプロイ」を選択。
2.  種類の選択で「ウェブアプリ」を選択。
3.  以下の設定でデプロイします。
    - **説明**: （任意）
    - **ウェブアプリを実行するユーザー**: 自分
    - **アクセスできるユーザー**: （セキュリティ要件に合わせて選択。例: `Googleアカウントを持つ全員`）
4.  「デプロイ」をクリックすると、ウェブアプリのURLが生成されます。このURLにアクセスするとツールを利用できます。

## 翻訳処理の仕組み（Queue方式）

### 概要

本ツールは、**Queue方式**による非同期翻訳処理を採用しています。これにより、大容量ファイルでも安定した翻訳処理を実現し、GASの実行時間制限（6分）を回避できます。

### 処理フロー

1. **翻訳ジョブのセットアップ**
   - ユーザーがファイルURLと翻訳設定を入力
   - `setupTranslationQueue`関数がファイルを解析し、個別のジョブに分割
   - 翻訳先の空ファイルを事前作成
   - ジョブ情報をキャッシュに保存し、タスクIDを発行

2. **非同期ジョブ処理**
   - フロントエンドが`processNextInQueue`を繰り返し呼び出し
   - 各呼び出しで1つのジョブ（セル単位）を処理
   - 翻訳結果を即座にファイルに書き込み
   - 進捗状況をリアルタイムで更新

3. **進捗管理と完了**
   - 処理済みジョブ数/総ジョブ数を追跡
   - プログレスバーでリアルタイム表示
   - 全ジョブ完了時に結果を表示

### 利点

- **スケーラビリティ**: 大容量ファイルでも処理可能
- **堅牢性**: 個別ジョブでエラーが発生しても処理継続
- **透明性**: リアルタイムの進捗表示
- **効率性**: 必要最小限のAPIコール

### 技術的詳細

- **キャッシュ**: `CacheService.getUserCache()`でタスク情報を管理（6時間有効）
- **ジョブ形式**: セル単位での翻訳ジョブ（位置情報とテキストを含む）
- **エラーハンドリング**: 個別ジョブの失敗時も次のジョブを処理継続
- **メモリ効率**: 一度に1つのジョブのみをメモリに保持

## 今後の展望

- 対応ファイル形式の追加（PDF、テキストファイルなど）
- 辞書機能の強化（正規表現対応、用語の自動抽出提案など）
- 他のLLM（Gemini, Claudeなど）への対応
- ドキュメントとプレゼンテーションのジョブ処理実装
