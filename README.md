# Google Drive 翻訳ツール

## 概要

このGoogle Apps Script（GAS）プロジェクトは、Google Drive上のファイル（スプレッドシート、ドキュメント、プレゼンテーション、PDF）を、OpenAIのLLM（`gpt-4.1-mini`）を利用して翻訳するためのWebアプリケーションです。

* Googleドライブ内で完結する
* 辞書を利用して共通コンテキストで単語を翻訳してくれる

翻訳を実行するたびに、AIが文脈から重要な用語ペアを自動で抽出し、スプレッドシートの辞書を拡充します。
一貫性のある翻訳ツールが欲しかったので作りました。

## 主な機能

### 🔥 AI辞書学習システム
- **用語ペア抽出**: 翻訳プロセスで、AIが必要と判断した名詞・固有名詞のペアを自動で抽出します。
- **重複の排除**: 抽出されたペアが既存辞書にあるかをシステムが確実に判定し、真に新しい用語のみを登録候補とします。

### 📄 多形式ファイル対応
- **Google スプレッドシート**: セル単位での学習・翻訳を実行
- **Google ドキュメント**: 段落単位での学習・翻訳を実行
- **Google プレゼンテーション**: テキストボックス単位での学習・翻訳を実行
- **PDF**: Googleドキュメントに変換してから翻訳を実行し、PDFファイルを出力

### 🧠 翻訳に使われているLLM

本プロジェクトでは **gpt-4.1-mini** を利用しています。
Model名を差し替えることで他のモデル (nanoモデルなど) を利用することが可能です。

## AI辞書学習システムの詳細

### 🔄 学習ワークフロー

```
1. 翻訳ジョブをファイル形式に応じて分割（セル、段落、テキストボックス単位）

2. 個々のジョブで、以下のループを実行:
   a) 既存辞書と原文から、LLMへの指示（XML形式）を生成
   b) LLMがXMLを解釈し、辞書ルールを遵守しながら翻訳を実行
   c) LLMが翻訳文から「すべての名詞・固有名詞ペア」を報告
   d) システムが報告された全ペアと既存辞書を比較し、「新規ペア」を特定
   e) 品質フィルタ（例：原文と訳文が同じペアを除外）を通過したものを辞書に自動登録

3. 次のジョブでは、更新された最新の辞書が利用される
```

### 🧩 システム構成要素

- **TermExtractor**: テキストから辞書照合用のキーワードを抽出するエンジン。
- **TermMatcher**: 抽出されたキーワードと既存辞書を照合するエンジン。
- **Translator**: `gpt-4.1-mini`に最適化したXMLプロンプトを生成し、翻訳と全用語ペアの抽出を指示する、システムの中核。
- **Dictionary**: 辞書データのCRUDとキャッシュを管理。
- **DictionaryQualityManager**: LLMが生成したペアの品質をチェックし、登録可否を判断。

## プロジェクト構成

```
/
├── Code.gs                      # メインロジック、非同期Queue処理
├── Config.gs                    # 設定ファイル、初期化処理  
├── Dictionary.gs                # 辞書CRUD操作、キャッシュ管理
├── DictionaryQualityManager.gs  # 用語品質評価・管理
├── FileHandler.gs               # ファイル種別判断・適切なハンドラへ委譲
├── SpreadsheetHandler.gs        # スプレッドシートのジョブ分割・書き込み処理
├── DocumentHandler.gs           # ドキュメントのジョブ分割・書き込み処理
├── PresentationHandler.gs       # プレゼンテーションのジョブ分割・書き込み処理
├── PdfHandler.gs                # PDF処理・変換処理
├── History.gs                   # 翻訳履歴記録・統計
├── TermExtractor.gs             # AI用語抽出エンジン
├── TermMatcher.gs               # 辞書照合エンジン
├── Translator.gs                # XMLベースのプロンプト生成・翻訳実行・用語ペア抽出
├── Utils.gs                     # XMLエスケープ等のユーティリティ関数
├── UI.html                      # フロントエンドUI
├── appsscript.json.example      # 設定ファイルの例
└── favicon.png                  # ファビコン
```

## 本アプリの制約

Google App Script の実行時間の制限を回避するため、Queue処理はフロントエンドで管理しています。
ブラウザを閉じると処理が中断される仕様です。

## セットアップとデプロイ

### 1. プロジェクトの作成
1. [Google Apps Script](https://script.google.com/)にアクセス
2. 新しいプロジェクトを作成
3. 本リポジトリのすべての`.gs`ファイルと`UI.html`をプロジェクトに追加

### 2. 設定ファイルの準備
1. `appsscript.json.example`を参考に、プロジェクトの`appsscript.json`を設定
2. 以下のサービスが有効になっていることを確認：
   - Google Drive API (v3)

### 3. OpenAI API設定
スクリプトプロパティに以下の値を設定：
- `OPENAI_API_KEY`: OpenAI APIキー
- `OPENAI_ORGANIZATION_ID`: OpenAI組織ID（任意）
- `OPENAI_PROJECT_ID`: OpenAIプロジェクトID（任意）

設定手順：
1. GASプロジェクト → プロジェクトの設定 → スクリプトプロパティ
2. 上記の値を追加

### 4. ファビコンの設定（任意）
1. `favicon.png`をGoogle Driveにアップロード
2. ファイルIDを取得し、`Config.gs`の`FAVICON_FILE_ID`に設定

### 5. デプロイ
1. GASエディタで「デプロイ」→「新しいデプロイ」を選択
2. 種類：ウェブアプリ
3. 実行者：自分
4. アクセスできるユーザー：組織内の任意のユーザー（または要件に応じて設定）
5. 「デプロイ」をクリック

### 6. 初期化
1. デプロイ完了後、ウェブアプリのURLにアクセス
2. 初回実行時、辞書・履歴管理用のスプレッドシートが自動作成されます

## 使用方法

### 基本的な翻訳手順
1. 翻訳したいGoogle DriveファイルのURLを入力
2. 翻訳先言語を選択
3. 使用する辞書を選択（デフォルトは「一般辞書」）
4. 「翻訳開始」をクリック
5. 処理完了まで待機（進捗はリアルタイムで表示）
6. 完了後、翻訳済みファイルのリンクが表示

### 辞書管理
- **新規辞書作成**: 専門分野ごとに独自の辞書を作成可能
- **用語の追加**: 手動で用語ペアを追加
- **インポート/エクスポート**: JSON形式での辞書の共有
- **自動学習**: 翻訳実行時に新しい用語ペアが自動的に追加

### 翻訳履歴の確認
- 過去の翻訳ジョブ一覧
- 使用した辞書、処理時間、文字数などの統計
- エラー情報の確認

## 対応ファイル形式

| ファイル形式 | 処理単位 | 説明 |
|-------------|----------|------|
| Google スプレッドシート | セル単位 | 各セルの内容を個別に翻訳 |
| Google ドキュメント | 段落単位 | 段落ごとに翻訳、書式は維持 |
| Google プレゼンテーション | テキストボックス単位 | スライド内のテキスト要素を翻訳 |
| PDF | ページ単位 | PDFを翻訳してGoogle ドキュメントとして出力 |

## トラブルシューティング

### よくある問題
1. **認証エラー**: スクリプトプロパティでOpenAI APIキーを確認
2. **ファイルアクセス不可**: Google Driveでのファイル共有設定を確認
3. **翻訳失敗**: APIレート制限やファイルサイズを確認
4. **用語抽出エラー**: ログを確認して原因を特定

### ログの確認
1. GASエディタ → 実行 → ログを表示
2. エラーメッセージから問題を特定
